<?php
session_start();
require 'includes/db_connect.php';
if (!isset($_SESSION['user_id'])) { header('Location: login.php'); exit; }
$user_id = intval($_SESSION['user_id']);
$is_admin = (isset($_SESSION['role']) && $_SESSION['role'] === 'admin');
$msg = '';
$error = '';

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['edit_id'])) {
  $customer_names = $_POST['customer_name'] ?? [];
  $purchased_froms = $_POST['purchased_from'] ?? [];
  $bottle_types = $_POST['bottle_type'] ?? [];
  $quantities = $_POST['quantity'] ?? [];
  $amounts = $_POST['amount'] ?? [];
  
  $allSuccess = true;
  
  // Process each bottle entry
  for ($i = 0; $i < count($quantities); $i++) {
    $customer_name = trim($customer_names[$i] ?? '');
    $purchased_from = trim($purchased_froms[$i] ?? '');
    $bottle_type = trim($bottle_types[$i] ?? '');
    $quantity = intval($quantities[$i] ?? 0);
    $amount = floatval($amounts[$i] ?? 0);

    // Check if quantity is valid
    if ($quantity <= 0) {
      $error = 'Please enter valid quantities greater than zero for all entries.';
      $allSuccess = false;
      break;
    } elseif ($amount < 0) {
      $error = 'Amount cannot be negative.';
      $allSuccess = false;
      break;
    } else {
      // insert deposit using prepared statement
      $ins = $conn->prepare("INSERT INTO deposit (user_id, customer_name, bottle_type, quantity, deposit_date) VALUES (?, ?, ?, ?, NOW())");
      $ins->bind_param("issi", $user_id, $customer_name, $bottle_type, $quantity);
      if ($ins->execute()) {
        // insert stock_log with purchased_from in details
        $details = "Successfully recorded" . ($purchased_from ? " from $purchased_from" : "");
        $log = $conn->prepare("INSERT INTO stock_log (user_id, action_type, customer_name, bottle_type, quantity, amount, details) VALUES (?, 'Deposit', ?, ?, ?, ?, ?)");
        $log->bind_param("issiis", $user_id, $customer_name, $bottle_type, $quantity, $amount, $details);
        $log->execute(); 
        $log->close();
      } else {
        $error = 'Database error: ' . $ins->error;
        $allSuccess = false;
        break;
      }
      $ins->close();
    }
  }
  
  if ($allSuccess && count($quantities) > 0) {
    $count = count($quantities);
    $msg = "Recorded $count deposit" . ($count > 1 ? "s" : "") . " successfully.";
    // Redirect to index after 1 second
    header("refresh:1;url=index.php");
  }
}

// fetch last 12 deposits for this user
$stmt = $conn->prepare("SELECT deposit_id, customer_name, bottle_type, quantity, deposit_date FROM deposit WHERE user_id = ? ORDER BY deposit_date DESC LIMIT 12");
$stmt->bind_param("i", $user_id);
$stmt->execute();
$deposits = $stmt->get_result();

// Handle admin correction (edit)
if ($is_admin && isset($_GET['edit_id'])) {
  $edit_id = intval($_GET['edit_id']);
  $eSt = $conn->prepare("SELECT deposit_id, customer_name, bottle_type, quantity, amount FROM deposit WHERE deposit_id = ?");
  $eSt->bind_param('i', $edit_id);
  $eSt->execute();
  $editRow = $eSt->get_result()->fetch_assoc();
  $eSt->close();
  if (!$editRow) {
    $error = 'Record not found for editing.';
  }
}

// Process admin update
if ($is_admin && $_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['edit_id'])) {
  $edit_id = intval($_POST['edit_id']);
  $new_customer = trim($_POST['customer_name'] ?? '');
  $new_bottle = trim($_POST['bottle_type'] ?? '');
  $new_qty = intval($_POST['quantity'] ?? 0);
  $new_amount = floatval($_POST['amount'] ?? 0);

  if ($new_qty <= 0) {
    $error = 'Correction quantity must be greater than zero.';
  } elseif ($new_amount < 0) {
    $error = 'Amount cannot be negative.';
  } else {
    $up = $conn->prepare("UPDATE deposit SET customer_name=?, bottle_type=?, quantity=? WHERE deposit_id=?");
    $up->bind_param('ssii', $new_customer, $new_bottle, $new_qty, $edit_id);
    if ($up->execute()) {
      $log = $conn->prepare("INSERT INTO stock_log (user_id, action_type, customer_name, bottle_type, quantity, amount) VALUES (?, 'Correction', ?, ?, ?, ?)");
      $note = "Correction for deposit #$edit_id";
      $log->bind_param('issid', $user_id, $note, $new_bottle, $new_qty, $new_amount);
      $log->execute(); $log->close();
      $msg = 'Record updated by admin.';
    } else {
      $error = 'Update failed: ' . $up->error;
    }
    $up->close();
  }
}
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Deposit • BottleBank</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="asset/style.css">
</head>
<body>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar">
    <div class="brand">
        <h1>BottleBank</h1>
    </div>
    <nav class="sidebar-nav">
        <a href="index.php">Dashboard</a>
        <a href="deposit.php" class="active">Deposit</a>
        <a href="returns.php">Returns</a>
        <a href="refund.php">Refund</a>
        <a href="stock_log.php">Stock Log</a>
        <?php if($is_admin): ?>
        <a href="admin/admin_panel.php">Admin Panel</a>
        <?php endif; ?>
        <a href="logout.php" class="logout">Logout</a>
    </nav>
</div>
  <div class="app">
  <div class="topbar">
    <div class="brand"><button class="toggle-sidebar" onclick="toggleSidebar()">☰</button><div class="logo">BB</div><div><h1>Deposit</h1><p class="kv">Record and manage bottle deposits</p></div></div>
    <div class="menu-wrap"><a href="index.php" class="kv">← Back to Dashboard</a></div>
  </div>

  <div class="grid" style="margin-top:8px;">
    <!-- Left Column: Form -->
    <div class="panel" style="grid-column: span 8;">
      <h3 style="margin-top:0;display:flex;align-items:center;gap:10px;">
        <span style="background:#26a69a;color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px">+</span>
        New Deposit
      </h3>

      <?php if($msg): ?>
        <div style="padding:12px 15px;background:#e9fbf1;border-left:4px solid #26a69a;border-radius:8px;margin-bottom:15px;color:#155724;font-weight:500">✓ <?=htmlspecialchars($msg)?></div>
      <?php endif; ?>

      <?php if($error): ?><div style="padding:12px 15px;background:#ffecec;border-left:4px solid #ef5350;border-radius:8px;margin-bottom:15px;color:#c62828;font-weight:500">✕ <?=htmlspecialchars($error)?></div><?php endif; ?>
      
      <form method="post" style="max-width:760px" onsubmit="return confirmDeposit(event)" id="depositForm">
        <div id="bottlesContainer">
          <div class="bottle-entry" style="border:1px solid #e0e0e0;padding:15px;border-radius:8px;margin-bottom:15px;background:#fafafa;">
            <div style="font-size:12px;color:#666;margin-bottom:10px;font-weight:600">BOTTLE #<span class="bottle-number">1</span></div>
            
            <div class="form-row">
              <div class="col">
                <label>Customer Name</label>
                <input type="text" name="customer_name[]" placeholder="Enter customer name">
              </div>
              <div class="col">
                <label>Purchased From</label>
                <input type="text" name="purchased_from[]" placeholder="Store/vendor name (optional)">
              </div>
            </div>

            <div class="form-row">
              <div class="col">
                <label>Bottle Type</label>
                <div style="display:flex;gap:8px;align-items:flex-end">
                  <select name="bottle_type[]" required id="bottleType_1">
                    <option value="">Select type...</option>
                    <option>Plastic Bottle (PET)</option>
                    <option>Glass Bottle</option>
                    <option>Can</option>
                    <option value="__custom__">+ Add Custom Type</option>
                  </select>
                  <input type="text" name="bottle_type_custom[]" placeholder="New type" style="display:none;flex:0.5" class="custom-bottle-input">
                </div>
              </div>
              <div class="col">
                <label>Quantity</label>
                <input type="number" name="quantity[]" min="1" placeholder="Number of bottles" required>
              </div>
            </div>

            <div class="form-row">
              <div class="col">
                <label>Amount (optional)</label>
                <input type="number" step="0.01" name="amount[]" min="0" placeholder="₱ 0.00">
              </div>
              <div class="col" style="display:flex;align-items:flex-end">
                <button type="button" class="ghost" onclick="removeBottle(this)" style="margin:0;color:#ef5350">Remove Entry</button>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="ghost" onclick="addMoreBottle()" style="margin-bottom:20px;color:#26a69a;border-color:#26a69a">+ Add Another Bottle</button>

        <div style="display:flex;gap:12px;margin-top:20px">
          <button type="submit" class="primary">Save All Deposits</button>
          <a href="index.php"><button type="button" class="ghost">Cancel</button></a>
        </div>
      </form>

      <script>
      function addMoreBottle(){
        const container = document.getElementById('bottlesContainer');
        const template = document.querySelector('.bottle-entry').cloneNode(true);
        template.querySelectorAll('input, select').forEach(el => el.value = '');
        const newNum = document.querySelectorAll('.bottle-entry').length + 1;
        template.querySelector('.bottle-number').textContent = newNum;
        template.querySelector('select').id = 'bottleType_' + newNum;
        template.querySelector('select').onchange = function(){ handleBottleTypeChange(this); };
        container.appendChild(template);
      }
      
      function handleBottleTypeChange(select){
        const customInput = select.closest('.form-row').querySelector('.custom-bottle-input');
        if(select.value === '__custom__'){
          customInput.style.display = 'block';
          customInput.required = true;
        } else {
          customInput.style.display = 'none';
          customInput.required = false;
          customInput.value = '';
        }
      }
      
      function removeBottle(btn){
        const entries = document.querySelectorAll('.bottle-entry');
        if(entries.length > 1){
          btn.closest('.bottle-entry').remove();
          // Update bottle numbers
          document.querySelectorAll('.bottle-number').forEach((el, idx) => {
            el.textContent = idx + 1;
          });
        } else {
          alert('You must have at least one bottle entry.');
        }
      }
      
      function confirmDeposit(e){
        const quantities = document.querySelectorAll('[name="quantity[]"]');
        const amounts = document.querySelectorAll('[name="amount[]"]');
        const bottleSelects = document.querySelectorAll('[name="bottle_type[]"]');
        let valid = true;
        
        quantities.forEach(q => {
          if(parseInt(q.value) <= 0){ alert('All quantities must be greater than zero.'); valid = false; }
        });
        amounts.forEach(a => {
          if(a.value && parseFloat(a.value) < 0){ alert('Amounts cannot be negative.'); valid = false; }
        });
        
        bottleSelects.forEach((sel, idx) => {
          if(sel.value === '__custom__'){
            const customInput = document.querySelectorAll('.custom-bottle-input')[idx];
            if(!customInput.value.trim()){ alert('Please enter a custom bottle type.'); valid = false; }
          }
        });
        
        if(!valid) e.preventDefault();
        return valid ? confirm('Confirm save all deposits?') : false;
      }
      
      // Set up change handlers for initial bottle type selects
      document.querySelectorAll('[name="bottle_type[]"]').forEach(sel => {
        sel.onchange = function(){ handleBottleTypeChange(this); };
      });
      </script>
      
      <?php if($is_admin && isset($editRow)): ?>
        <h3>Edit Deposit #<?= $editRow['deposit_id'] ?></h3>
        <form method="POST" onsubmit="return confirmCorrection(event)">
          <input type="hidden" name="edit_id" value="<?= $editRow['deposit_id'] ?>">
          <label>Customer Name</label>
          <input type="text" name="customer_name" value="<?=htmlspecialchars($editRow['customer_name'])?>">
          <label>Bottle Type</label>
          <input type="text" name="bottle_type" value="<?=htmlspecialchars($editRow['bottle_type'])?>">
          <label>Quantity</label>
          <input type="number" name="quantity" min="1" value="<?=htmlspecialchars($editRow['quantity'])?>" required>
          <label>Amount (optional)</label>
          <input type="number" step="0.01" name="amount" min="0" value="<?=htmlspecialchars($editRow['amount'] ?? '')?>">
          <div style="margin-top:8px"><button type="submit">Save Correction</button></div>
        </form>
        <script>
          function confirmCorrection(e){
            const amtInput = document.querySelector('form input[name="amount"]');
            const amt = parseFloat(amtInput && amtInput.value ? amtInput.value : '0') || 0;
            if(amt < 0){ alert('Amount cannot be negative.'); e.preventDefault(); return false; }
            return confirm('Apply this correction?');
          }
        </script>
      <?php endif; ?>
      </form>

  </div>
  </div>

  <div class="footer">© <?=date('Y')?> BottleBank</div>
</div>

<script>
function toggleSidebar(){
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.sidebar-overlay');
  sidebar.classList.toggle('active');
  overlay.classList.toggle('active');
}

// Close sidebar when clicking on a navigation link
document.querySelectorAll('.sidebar-nav a').forEach(link => {
  link.addEventListener('click', function(){
    if(window.innerWidth <= 768){
      toggleSidebar();
    }
  });
});
</script>
</body>
</html>
